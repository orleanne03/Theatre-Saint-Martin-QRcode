<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√©servation ‚Äì Th√©√¢tre Saint Martin</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
  :root {
    --color-primary: #2563eb;
    --color-accent: #16a34a;
    --color-danger: #ef4444;
    --color-bg: #f8fafc;
    --color-highlight: #facc15;
  }

  body {
    font-family: "Poppins", sans-serif;
    background: var(--color-bg);
    color: #333;
    text-align: center;
    padding: 12px;
    margin: 0;
  }

  h1 {
    color: var(--color-primary);
    margin-bottom: 10px;
    font-size: clamp(1.2rem, 4vw, 1.8rem);
  }

  button {
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 14px;
    font-size: clamp(0.9rem, 2.5vw, 1rem);
    margin: 5px;
    cursor: pointer;
    transition: all 0.25s ease;
    touch-action: manipulation;
  }

  button:hover { background: #1e40af; transform: scale(1.05); }

  input[type="text"] {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: clamp(0.9rem, 3vw, 1rem);
    margin: 8px;
    width: 80%;
    max-width: 280px;
  }

  .salle {
    display: flex;
    flex-direction: column-reverse;
    align-items: center;
    gap: 6px;
    margin: 15px auto;
    overflow-x: auto;
  }

  .rangee-container { display: flex; align-items: center; gap: 6px; }
  .numero-rangee { width: 20px; font-weight: 500; font-size: 0.8rem; color: #555; }
  .rangee { display: grid; grid-template-columns: repeat(16, 1fr); gap: 4px; }

  .siege {
    width: 30px; height: 30px;
    background: #d1d5db;
    border-radius: 6px;
    font-size: 0.65rem;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.25s ease;
    user-select: none;
  }

  .siege.reserve { background: var(--color-danger); color: #fff; font-weight: 600; }
  .siege.selected { background: var(--color-accent); color: #fff; }
  .siege.highlight { background: var(--color-highlight) !important; color: #000 !important; border: 1px solid #facc15; box-shadow: 0 0 8px #facc15; }
  .siege.dimmed { opacity: 0.2; filter: grayscale(90%); }
  .siege:hover { transform: scale(1.2); background: #93c5fd; }

  .scene {
    background: linear-gradient(to top, #e5e7eb, #d1d5db);
    border: 2px solid #9ca3af;
    border-radius: 8px;
    width: 90%; max-width: 700px;
    margin: 20px auto 10px;
    padding: 10px;
    font-weight: 600;
    font-size: clamp(1rem, 3vw, 1.2rem);
    color: #374151;
    box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.2);
  }

  .legend {
    display: flex; flex-wrap: wrap; justify-content: center;
    gap: 12px; font-size: 0.85rem; margin-top: 10px;
  }

  .box { width: 16px; height: 16px; border-radius: 4px; display: inline-block; margin-right: 4px; }
  .box.dispo { background: #d1d5db; }
  .box.reserve { background: var(--color-danger); }
  .box.selected { background: var(--color-accent); }

  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 95%;
    font-size: 0.85rem;
  }

  th, td { border: 1px solid #ccc; padding: 6px; }
  th { background: var(--color-primary); color: white; }

  footer { margin-top: 30px; font-size: 0.8rem; color: #777; }

  .modal-bg {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal {
    background: white; padding: 20px; border-radius: 12px;
    width: 85%; max-width: 320px; text-align: left;
  }

  .modal h3 { margin-bottom: 10px; font-size: 1rem; }
  .modal input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin-top: 8px; margin-bottom: 15px; }

  .modal-buttons { display: flex; justify-content: space-between; }
  .btn-cancel { background: #9ca3af; }
  .btn-cancel:hover { background: #6b7280; }

  @media (max-width: 600px) {
    .rangee { grid-template-columns: repeat(8, 1fr); }
    .siege { width: 34px; height: 34px; font-size: 0.7rem; }
  }

  @media print {
    button, .legend, .panel, table, footer, .modal-bg, #searchInput { display: none !important; }
  }
</style>
</head>
<body>

<h1>üé≠ R√©servation ‚Äì Th√©√¢tre Saint Martin</h1>
<input type="text" id="searchInput" placeholder="üîç Rechercher un nom...">

<div class="salle" id="salle"></div>
<div class="scene">üé≠ SC√àNE</div>

<div class="legend">
  <div><span class="box dispo"></span>Disponible</div>
  <div><span class="box selected"></span>S√©lectionn√©</div>
  <div><span class="box reserve"></span>R√©serv√©</div>
</div>

<div class="panel">
  <button id="reserveBtn">R√©server</button>
  <button id="resetBtn">R√©initialiser</button>
  <button id="exportBtn">Exporter CSV</button>
  <button id="printBtn">üñ®Ô∏è Imprimer / PDF</button>
  <button onclick="window.location='index.html'">‚¨ÖÔ∏è Accueil</button>
</div>

<h3>üìã Liste des r√©servations</h3>
<table id="tableResa">
  <thead><tr><th>Rang√©e</th><th>Si√®ge</th><th>Nom</th></tr></thead>
  <tbody></tbody>
</table>

<footer>üíô Th√©√¢tre Saint Martin ‚Äì Version compl√®te</footer>

<!-- Fen√™tre modale -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>Nouvelle r√©servation</h3>
    <p id="modalText"></p>
    <input type="text" id="nomInput" placeholder="Nom du r√©servant">
    <input type="email" id="emailInput" placeholder="Adresse e-mail (optionnelle)">
    <div class="modal-buttons">
      <button id="cancelModal" class="btn-cancel">Annuler</button>
      <button id="confirmModal">Confirmer</button>
    </div>
  </div>
</div>

<script>
emailjs.init("2m3fNNkp36a2wCfZn"); // üîë ton identifiant EmailJS
console.log("‚úÖ EmailJS initialis√©");
const nbRangees = 20, nbParRangee = 16, adminPassword = "admin123";
let selected = [], reservations = JSON.parse(localStorage.getItem("reservations") || "{}");

const salle = document.getElementById("salle"),
      tableBody = document.querySelector("#tableResa tbody"),
      modalBg = document.getElementById("modalBg"),
      nomInput = document.getElementById("nomInput"),
      modalText = document.getElementById("modalText"),
      searchInput = document.getElementById("searchInput");
let confirmAction = null;

function save() { localStorage.setItem("reservations", JSON.stringify(reservations)); }

function render() {
  salle.innerHTML = "";
  for (let r = 1; r <= nbRangees; r++) {
    const rc = document.createElement("div");
    rc.classList.add("rangee-container");
    const num = document.createElement("div");
    num.classList.add("numero-rangee");
    num.textContent = r;
    rc.appendChild(num);
    const row = document.createElement("div");
    row.classList.add("rangee");

    for (let c = 1; c <= nbParRangee; c++) {
      const id = `${r}-${c}`;
      const seat = document.createElement("div");
      seat.classList.add("siege");
      if (reservations[id]) {
        seat.classList.add("reserve");
        seat.textContent = reservations[id].substring(0, 3);
      } else seat.textContent = c;
      if (selected.includes(id)) seat.classList.add("selected");
      seat.onclick = () => {
        if (reservations[id]) {
          const pwd = prompt(`R√©serv√© par ${reservations[id]}. Mot de passe admin ?`);
          if (pwd === adminPassword) { delete reservations[id]; save(); render(); }
        } else {
          selected = selected.includes(id) ? selected.filter(s => s !== id) : [...selected, id];
          render();
        }
      };
      row.appendChild(seat);
    }
    rc.appendChild(row); salle.appendChild(rc);
  }
  updateTable(); applySearch();
}

function updateTable() {
  tableBody.innerHTML = "";
  Object.entries(reservations).forEach(([key, name]) => {
    const [r, c] = key.split("-");
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r}</td><td>${c}</td><td>${name}</td>`;
    tableBody.appendChild(tr);
  });
}

function applySearch() {
  const q = searchInput.value.trim().toLowerCase();
  const seats = document.querySelectorAll(".siege");
  const rows = tableBody.querySelectorAll("tr");
  seats.forEach(s => s.classList.remove("dimmed", "highlight"));
  rows.forEach(r => (r.style.display = ""));
  if (q) {
    seats.forEach(seat => {
      const rangee = seat.parentElement.parentElement.querySelector(".numero-rangee").textContent;
      const id = `${rangee}-${seat.textContent}`;
      const name = reservations[id];
      if (name && name.toLowerCase().includes(q)) seat.classList.add("highlight");
      else seat.classList.add("dimmed");
    });
    rows.forEach(row => {
      const name = row.cells[2].textContent.toLowerCase();
      if (!name.includes(q)) row.style.display = "none";
    });
  }
}
searchInput.oninput = applySearch;

function openModal(msg, onConfirm) {
  modalText.textContent = msg;
  modalBg.style.display = "flex";
  nomInput.value = ""; document.getElementById("emailInput").value = "";
  confirmAction = onConfirm;
}
function closeModal() { modalBg.style.display = "none"; confirmAction = null; }

document.getElementById("confirmModal").onclick = async () => {
  const nom = nomInput.value.trim();
  const email = document.getElementById("emailInput").value.trim();
  if (!nom) return alert("Veuillez entrer un nom.");
  if (confirmAction) await confirmAction(nom, email);
  closeModal();
};
document.getElementById("cancelModal").onclick = closeModal;

// --- G√©n√©ration du ticket + envoi e-mail ---
async function genererTicketPDF(nom, sieges, email) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const date = new Date().toLocaleDateString("fr-FR", { weekday:"long", year:"numeric", month:"long", day:"numeric" });

  const uid = `${nom}-${Date.now()}`;
  const qr = new QRious({ value: uid, size: 100 });
  const qrData = qr.toDataURL();

  // --- contenu du ticket ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(20);
  doc.text("üé≠ Th√©√¢tre Saint Martin", 20, 25);
  doc.setFontSize(12);
  doc.text(`Nom : ${nom}`, 20, 45);
  doc.text(`Date : ${date}`, 20, 55);
  doc.text("Si√®ges r√©serv√©s :", 20, 70);
  let y = 80;
  sieges.forEach(id => {
    const [r, c] = id.split("-");
    doc.text(`‚Üí Rang√©e ${r}, Si√®ge ${c}`, 25, y);
    y += 8;
  });
  doc.addImage(qrData, "PNG", 140, 35, 45, 45);
  doc.text("Merci pour votre r√©servation et bon spectacle !", 20, y + 15);
  doc.setDrawColor(37, 99, 235);
  doc.rect(10, 15, 190, y + 25, "S");

  const blob = doc.output("blob");

  // --- Envoi EmailJS ---
  if (email) {
    const reader = new FileReader();
    reader.onload = async () => {
      const base64PDF = reader.result.split(",")[1]; // contenu du PDF encod√©

      const params = {
        to_email: email,
        to_name: nom,
        message: "Voici votre ticket üé≠ en pi√®ce jointe.",
        my_pdf: base64PDF, // important : doit correspondre au champ dans le template
      };

      try {
        console.log("‚è≥ Envoi en cours vers", email);
        const res = await emailjs.send(
          "service_91fpmi6",      // ‚Üê ton Service ID exact
          "template_xzjnnc2",     // ‚Üê ton Template ID exact
          params,
          "2m3fNNkp36a2wCfZn"    // ‚Üê ta cl√© publique
        );
        console.log("‚úÖ Email envoy√© :", res);
        alert(`üé´ Ticket envoy√© √† ${email}`);
      } catch (err) {
        console.error("‚ùå Erreur EmailJS :", err);
        alert("Erreur EmailJS : " + (err.text || err.message));
      }
    };

    reader.readAsDataURL(blob); // encode le PDF avant envoi
  } else {
    doc.save(`ticket_${nom}.pdf`);
  }
}



document.getElementById("reserveBtn").onclick = () => {
  if (!selected.length) return alert("Aucun si√®ge s√©lectionn√© !");
  openModal(`R√©server ${selected.length} si√®ge(s) pour :`, async (nom, email) => {
    selected.forEach(id => (reservations[id] = nom));
    await genererTicketPDF(nom, selected, email);
    selected = []; save(); render();
  });
};

document.getElementById("resetBtn").onclick = () => {
  const pwd = prompt("Mot de passe admin pour tout r√©initialiser :");
  if (pwd === adminPassword && confirm("Tout supprimer ?")) {
    reservations = {}; save(); render();
  }
};

document.getElementById("exportBtn").onclick = () => {
  const rows = [["Rang√©e","Si√®ge","Nom"], ...Object.entries(reservations).map(([id,nom]) => [...id.split("-"),nom])];
  const csv = rows.map(r=>r.join(",")).join("\n");
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="reservations.csv"; a.click();
};
document.getElementById("printBtn").onclick = () => window.print();

render();
</script>
</body>
</html>










